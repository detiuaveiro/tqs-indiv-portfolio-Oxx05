<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>ZeroMonos - Cidad√£o</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2rem; }
        textarea, select, input { margin-top: 0.3rem; margin-bottom: 0.8rem; width: 100%; }
        .token-box { background: #f0f0f0; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; }
        .token-item { background: #fff; border: 1px solid #ccc; padding: 0.5rem; margin: 0.3rem 0; border-radius: 5px; font-family: monospace; }
        button { margin-top: 0.5rem; margin-right: 0.5rem; cursor: pointer; }
        #bookingResult { margin-top: 1rem; white-space: pre-wrap; }
        #createMessage { margin-top: 0.8rem; color: green; font-weight: bold; }
        #tokenList { margin-top: 0.5rem; display: none; }
        .error { color: red; font-weight: bold; margin-top: 0.5rem; }
    </style>
</head>
<body>
<h1>Reserva de Recolha</h1>

<div class="token-box">
    <button id="toggleTokens" onclick="toggleTokenList()">üîΩ Ver pedidos feitos</button>
    <div id="tokenList">Nenhum token ainda.</div>
</div>

<form id="bookingForm">
    <label>Data e hora:</label>
    <input type="datetime-local" id="date" required>

    <label for="municipalityInput">Munic√≠pio:</label>
    <input type="text" id="municipalityInput" list="municipalitiesList" placeholder="Escolha o munic√≠pio" required>
    <datalist id="municipalitiesList"></datalist>
    <div id="municipalityError" class="error"></div>

    <label>Descri√ß√£o:</label>
    <textarea id="description" required></textarea>

    <button type="submit">Submeter</button>
    <div id="createMessage"></div>
</form>

<hr>

<h3>Consultar / Cancelar Pedido</h3>
<label>Token:</label>
<input type="text" id="token">
<button onclick="checkBooking()">Ver estado</button>
<button onclick="cancelBooking()">Cancelar</button>

<div id="bookingResult"></div>

<script>
    const tokenList = [];
    let tokenListVisible = false;
    let validMunicipalities = [];

    async function loadMunicipalities() {
        const res = await fetch('/api/municipalities');
        validMunicipalities = await res.json();
        const datalist = document.getElementById('municipalitiesList');
        datalist.innerHTML = validMunicipalities.map(m => `<option value="${m}"></option>`).join('');
    }

    function renderTokenList() {
        const div = document.getElementById('tokenList');
        if (tokenList.length === 0) {
            div.innerText = "Nenhum token ainda.";
        } else {
            div.innerHTML = tokenList.map(t => `<div class="token-item">${t}</div>`).join('');
        }
    }

    function toggleTokenList() {
        const div = document.getElementById('tokenList');
        const btn = document.getElementById('toggleTokens');
        tokenListVisible = !tokenListVisible;

        if (tokenListVisible) {
            div.style.display = "block";
            btn.textContent = "üîº Ocultar pedidos feitos";
        } else {
            div.style.display = "none";
            btn.textContent = "üîΩ Ver pedidos feitos";
        }
    }

    document.getElementById('bookingForm').addEventListener('submit', async e => {
        e.preventDefault();

        const municipalityInput = document.getElementById('municipalityInput').value.trim();
        const errorDiv = document.getElementById('municipalityError');
        errorDiv.textContent = "";

<!--        if (!validMunicipalities.includes(municipalityInput)) {-->
<!--            errorDiv.textContent = "Por favor, selecione um munic√≠pio v√°lido.";-->
<!--            return;-->
<!--        }-->

        const payload = {
            date: document.getElementById('date').value,
            municipality: municipalityInput,
            description: document.getElementById('description').value
        };

        const res = await fetch('/api/requests', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const msgDiv = document.getElementById('createMessage');

        try {
            const data = await res.json();

            if (!res.ok) {
                msgDiv.style.color = "red";
                msgDiv.innerText = `‚ùå ${data.error || "Erro ao criar pedido."}`;
                return;
            }

            // sucesso
            tokenList.push(data.token);
            renderTokenList();

            msgDiv.style.color = "green";
            msgDiv.innerText = `‚úÖ Pedido criado! Token: ${data.token}`;
            document.getElementById('bookingResult').innerText = "";

        } catch (e) {
            msgDiv.style.color = "red";
            msgDiv.innerText = "‚ùå Erro inesperado ao processar a resposta.";
        }
    });


    async function checkBooking() {
        const token = document.getElementById('token').value.trim();
        if (!token) return;

        const res = await fetch(`/api/requests/${token}`);
        const container = document.getElementById('bookingResult');

        if (res.ok) {
            const data = await res.json();
            let text = `üìÑ Token: ${data.token}\n`;
            text += `Munic√≠pio: ${data.municipality}\n`;
            text += `Descri√ß√£o: ${data.description}\n`;
            text += `Data: ${new Date(data.date).toLocaleString()}\n`;
            text += `Estado atual: ${data.state}\n\nüìú Hist√≥rico:\n`;

            if (data.history && data.history.length > 0) {
                for (const h of data.history) {
                    text += `‚Üí ${h.state} em ${new Date(h.changeDate).toLocaleString()}\n`;
                }
            } else {
                text += "Sem hist√≥rico de altera√ß√µes.";
            }

            container.innerText = text;
        } else {
            container.innerText = "‚ùå Pedido n√£o encontrado.";
        }
    }

    async function cancelBooking() {
        const token = document.getElementById('token').value.trim();
        if (!token) return;

        const res = await fetch(`/api/requests/${token}`, { method: 'DELETE' });
        document.getElementById('bookingResult').innerText =
            res.ok ? "üõë Pedido cancelado." : "Erro ao cancelar.";
    }

    loadMunicipalities();
</script>
</body>
</html>
